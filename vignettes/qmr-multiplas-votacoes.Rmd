---
title: "Construindo o dataframe do QMR a partir de um arquivo contendo múltiplas votações"
author: "Paulo Vinícius Soares"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Construindo o dataframe do QMR a partir de um arquivo contendo múltiplas votações}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(readr)
library(DT)
library(rcongresso)
library(magrittr)
library(knitr)
```

# Introdução
Construir um *dataframe* selecionando manualmente cada votação é cansativo e requer muito tempo, de forma que podemos automatizar esse processo e construir um *dataframe* a partir de um arquivo contendo as informações necessárias para obter os **ids das proposições**.  

Caso você não tenha lido o outro *vignette* sobre a [construção de um *dataframe* a partir de uma votação](qmr-uma-votacao.html), eu recomendo que você o faça para compreender melhor a maneira como os dados estão organizados.    


# Montando o arquivo de entrada
Três informações são necessárias para obter os **ids das proposições**: **tipo**, **número** e **ano** da proposição. Dessa maneira, o arquivo deve seguir o formato:

```
tipo, numero, ano
"A",1234,1992
"B",4321,2002
[...]
[...]
"Z",9999,2017
```

# Utilizando o script  

O *script* para execução pode ser encontrado abaixo, junto com um exemplo de utilização. As votações selecionadas foram as últimas ocorridas na câmara referentes a cada proposição.Além disso, este retorna um *dataframe* contendo 36 colunas com informações resultantes dos joins entre as proposições, votações e votos. O usuário deve adaptar o *script* fazendo *select* das variáveis que lhe interessa.

## R

```{r}
arquivo_proposicoes <- system.file("extdata", "arquivo_proposicoes.txt", package = "rcongresso")

ids_proposicoes <- arquivo_proposicoes  %>%
  read_csv(col_types = cols(
    tipo = col_character(),
    numero = col_integer(),
    ano = col_integer()
  )) %>%
  rowwise() %>%
  do(tibble(id = fetch_id_proposicao(.$tipo, .$numero, .$ano)))

proposicoes <- fetch_proposicao(ids_proposicoes$id)

ultimas_votacoes <- fetch_votacoes(ids_proposicoes$id) %>%
  ultima_votacao()

votacoes_relevantes <- fetch_votacao(ultimas_votacoes$id)

votacoes <- constroi_dataframe(proposicoes, votacoes_relevantes)
```

O exemplo do dataframe abaixo, com apenas algumas colunas selecionadas.

```{r}
votacoes %>%
  select(
    voto,
    nome=parlamentar.nome,
    partido=parlamentar.siglaPartido,
    siglaTipo,
    numero,
    ano,
    orient_part=orientacao_partido,
    orient_gov=orientacao_governo
    ) %>%
  datatable()
```


## Bash

Também é possível utilizar um *script bash* que seja executado a partir da linha de comando de um terminal linux. O uso segue o seguinte formato:

```
./pega_votacoes.R <arquivo_de_proposicoes>
```
O script *pega_votacoes.R* abaixo:
```
#!/usr/bin/env Rscript
library(dplyr)
library(readr)
library(rcongresso)

args = commandArgs(trailingOnly = TRUE)
if (length(args) != 1) {
  stop(
    "Uso: pega_votacoes.R <arquivo_de_proposicoes>"
  )
}

arquivo_proposicoes <- args[1]

ids_proposicoes <- arquivo_proposicoes  %>%
  read_csv(col_types = cols(
    tipo = col_character(),
    numero = col_integer(),
    ano = col_integer()
  )) %>%
  rowwise() %>%
  do(tibble(id = fetch_id_proposicao(.$tipo, .$numero, .$ano)))


proposicoes <- fetch_proposicao(ids_proposicoes$id)

ultimas_votacoes <- fetch_votacoes(ids_proposicoes$id) %>%
  ultima_votacao()

votacoes_relevantes <- fetch_votacao(ultimas_votacoes$id)

constroi_dataframe(proposicoes, votacoes_relevantes) %>%
  format_csv() %>%
  writeLines(stdout())
```

O resultado será impresso na saída padrão do terminal, que é o próprio console.

