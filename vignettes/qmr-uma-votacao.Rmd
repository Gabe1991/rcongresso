---
title: "Construindo o dataframe do QMR a partir de uma votação"
author: "Paulo Vinícius Soares"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Construindo o dataframe do QMR a partir de uma votação}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, warning=FALSE, message=FALSE}
library(rcongresso)
library(DT)
library(magrittr)
library(dplyr)
library(knitr)
```


# Introdução
Este pacote é baseado na nova [API REST](https://dadosabertos.camara.leg.br/swagger/api.html) da Câmara dos Deputados. A API fornece funções para pegar muitas informações interessantes para os analistas de dados. A intenção desse pacote é ser um *wrapper* retornando *dataframes* prontos facilitando a vida dos usuários.

# Compreendendo a organização das funções e dos dados
Para gerar o *dataframe*, precisamos entender um pouco como se dá a organização da câmara ao gerar as proposições e como estas informações estão organizadas na base de dados.

## Pegando uma proposição da base de dados
Para recuperar uma proposição você precisa de três informações: O **tipo da proposição** (i.e., PEC, PL, PLP), o **número da proposição** e o **ano** em que esta foi proposta. Com essas três informações em mãos podemos recuperar o **ID da proposição** da base de dados e, consequentemente, a proposição.    

Vamos utilizar como exemplo a *PL 4302/1998*, o projeto de lei da terceirização. Já temos as informações necessárias para recuperar o ID desta, então fazemos uma chamada à função `fetch_id_proposicao()`.

```{r}
pl4302_id <- fetch_id_proposicao(tipo="PL", numero=4302, ano=1998)
```

Com o ID da proposição em mãos, podemos recuperar a proposição em si contendo as informações relevantes sobre esta. Fazemos isso com uma chamada à função `fetch_proposicao()`
```{r}
pl4302 <- fetch_proposicao(id_prop=pl4302_id)
```

Essas são as informações que dispomos sobre a proposição:
```{r}
colnames(pl4302)
```

Um resumo das informações referentes à proposição podem ser vistas abaixo:
```{r}
pl4302 %>% 
  select(id, uri, numero, ano, ementa, dataApresentacao) %>%
  kable()
```

## Selecionando a votação desejada

Com o ID da proposição, além da proposição em si, podemos recuperar **todas as votações pelas quais aquela proposição já passou**. Fazemos isso com uma chamada à função `fetch_votacoes()`   

```{r}
votacoes_pl4302 <- fetch_votacoes(id_prop=pl4302_id)
```

Essas são todas as informações que dispomos sobre as votações retornadas:
```{r}
colnames(votacoes_pl4302)
```

Temos abaixo um resumo do *dataframe* retornado:

```{r}
votacoes_pl4302 %>% 
  select(id, titulo, placarSim, placarNao, placarAbstencao) %>% 
  kable()
```

Com essas informações em mãos podemos escolher uma votação para analisarmos melhor. Escolhemos a votação pelo seu ID. Fazemos isso com uma chamada à função `fetch_votacao()`  
Vamos escolher a votação cujo título é "SUBSTITUTIVO DO SENADO FEDERAL" e tem ID=7431.

```{r}
votacao_aprovacao_terceirizacao <- fetch_votacao(id_votacao=7431)
```

Essas são todas as informações que dispomos sobre a votação:
```{r}
colnames(votacao_aprovacao_terceirizacao)
```

Temos abaixo um resumo do *dataframe* retornado:
```{r}
data.frame(id=votacao_aprovacao_terceirizacao$id, titulo=votacao_aprovacao_terceirizacao$titulo, 
           dataHoraInicio=votacao_aprovacao_terceirizacao$dataHoraInicio, dataHoraFim=votacao_aprovacao_terceirizacao$dataHoraFim) %>%
  kable()
```

Podemos ver, a partir dessa variável acessando o *dataframe* **orientacoes**, a orientação das bancadas. Essa informação é crucial para construir o dataframe final. Para isso utilizamos a função `fetch_orientacoes()`

```{r}
fetch_orientacoes(id_votacao=7431) %>% 
  select(nomeBancada, voto) %>% 
  datatable()
```

## Pegando os votos dos deputados

Com o ID da votação, além da votação em si, podemos recuperar todas os **votos dos deputados que participaram daquela votação**. Fazemos isso utilizando a função `fetch_votos()`.

```{r}
votos_aprovacao_terceirizacao <- fetch_votos(id_votacao=7431)
```

Essas são todas as informações que dispomos sobre os votos:
```{r}
colnames(votacao_aprovacao_terceirizacao)
```

Temos abaixo um resumo do *dataframe* retornado:
```{r}
votos_aprovacao_terceirizacao %>% 
  select(parlamentar.id, parlamentar.nome, parlamentar.siglaPartido, voto) %>% 
  datatable()
```

## Gerando o dataframe base

Com as informações sobre a votação e a proposição já estamos prontos para construir o nosso dataframe final. Para tal, fazemos uma chamada à função `constroi_dataframe()`. A seguir temos o exemplo do dataframe. Os votos dos deputados são selecionados pela função com base na votação passada.

```{r}
dataframe_pl4302 <- constroi_dataframe(proposicao=pl4302, votacao=votacao_aprovacao_terceirizacao)
```

Essas são todas as informações que dispomos sobre o dataframe final:
```{r}
colnames(dataframe_pl4302)
```

Temos abaixo um resumo do *dataframe* retornado:
```{r}
dataframe_pl4302 %>%
  select(
    voto, 
    dep_id=parlamentar.id, 
    partido=parlamentar.siglaPartido,
    tipo_prop,
    numero,
    ano,
    orient_part=orientacao_partido,
    orient_gov=orientacao_governo
    ) %>%
  datatable()
```







